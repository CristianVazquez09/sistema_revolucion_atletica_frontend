<div class="mx-4 md:mx-8 my-4 min-h-[calc(100vh-120px)] grid grid-cols-1 lg:grid-cols-[520px_1fr] gap-6">

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CARRITO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section class="rounded-xl2 bg-[color:var(--color-ra-white)] ring-1 ring-black/10 shadow-card flex flex-col">
    <header class="px-4 py-3 border-b border-[color:var(--color-ra-grayLight)]/60">
      <h2 class="font-semibold text-[color:var(--color-ra-slate)]">Lista</h2>
    </header>

    <div class="p-3 flex-1">
      <div class="rounded-lg border border-gray-200 bg-gray-50 h-full">
        <table class="w-full text-sm">
          <thead class="text-[color:var(--color-ra-slate)]/90">
            <tr>
              <th class="text-left px-3 py-2">Producto</th>
              <th class="text-center px-3 py-2 w-[110px]">Cantidad</th>
              <th class="text-right px-3 py-2 w-[120px]">Precio</th>
            </tr>
          </thead>
          <tbody>
            @if (carrito.length === 0) {
              <tr>
                <td colspan="3" class="px-3 py-10 text-center text-[color:var(--color-ra-slate)]">
                  Selecciona una categor√≠a o usa el buscador para ver productos.
                </td>
              </tr>
            } @else {
              @for (linea of carrito; track $index) {
                <tr class="border-t border-gray-200 hover:bg-white/70 cursor-pointer"
                    [class.bg-red-50]="$index === indiceCarritoSeleccionado"
                    (click)="seleccionarLineaCarrito($index)">
                  <td class="px-3 py-2 truncate">{{ linea.nombre }}</td>
                  <td class="px-3 py-2 text-center">{{ linea.cantidad }}</td>
                  <td class="px-3 py-2 text-right">
                    {{ linea.precioUnit * linea.cantidad | currency:'USD':'symbol':'1.2-2' }}
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>
    </div>

    <!-- Total + acciones -->
    <div class="px-3">
      <div class="flex items-center justify-between rounded-lg bg-gray-100 border border-gray-200 px-3 py-2">
        <div class="font-semibold text-[color:var(--color-ra-slate)]">TOTAL</div>
        <div class="font-bold">{{ total | currency:'USD':'symbol':'1.2-2' }}</div>
      </div>

      <div class="mt-3 flex items-center gap-2">
        <button class="icon-btn" (click)="sumar()" title="Sumar">+</button>
        <button class="icon-btn" (click)="restar()" title="Restar">‚àí</button>
        <button
          class="px-4 py-1.5 rounded-md bg-[color:var(--color-ra-rojo-oscuro)]/90 text-white hover:bg-[color:var(--color-ra-rojo-oscuro)]"
          (click)="eliminarSeleccionado()">Eliminar</button>
      </div>
    </div>

    <footer class="mt-auto p-3 flex items-center gap-3">
      <button class="btn-green flex-1" (click)="abrirModalResumen()">Pagar</button>
      <button class="btn-red flex-1" (click)="cancelar()">Cancelar</button>
    </footer>
  </section>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PANEL DERECHO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section class="rounded-xl2 bg-[color:var(--color-ra-white)] ring-1 ring-black/10 shadow-card p-4 flex flex-col gap-4">

    <!-- Encabezado din√°mico -->
    <div class="flex items-center justify-between">
      @if (modo === 'productos') {
        <!-- Bot√≥n Volver (outline) -->
        <div class="flex items-center gap-2">
          <button type="button" (click)="volverACategorias()"
                  class="group inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-gray-300 bg-white
                         text-sm font-medium text-[color:var(--color-ra-slate)] shadow-sm
                         hover:bg-gray-50 hover:border-[color:var(--color-ra-rojo)] hover:text-[color:var(--color-ra-rojo)]
                         focus:outline-none focus:ring-2 focus:ring-[color:var(--color-ra-rojo)]/40 transition">
            <svg viewBox="0 0 24 24" fill="none" class="w-4 h-4 transition-transform group-hover:-translate-x-0.5">
              <path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
            </svg>
            Volver
          </button>
        </div>
      } @else {
        <div></div>
      }

      <!-- Buscador -->
      <div class="w-full max-w-[520px] ml-auto">
        <div class="relative">
          <input class="input-filled pr-10" placeholder="Buscar producto por nombre o c√≥digo‚Ä¶"
                 [ngModel]="terminoBusqueda" (ngModelChange)="onBuscarChange($event)">
          <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-gray-500">üîç</div>
        </div>
      </div>
    </div>

    <!-- Vista CATEGOR√çAS -->
    @if (modo === 'categorias') {
      <div class="flex-1 flex flex-col">
        <div class="cat-grid flex-1">
          @if (cargandoCategorias) {
            <div class="cat-grid__empty">Cargando categor√≠as‚Ä¶</div>
          } @else if (categorias.length === 0) {
            <div class="cat-grid__empty">Sin categor√≠as.</div>
          } @else {
            @for (c of categoriasVisibles; track c.idCategoria) {
              <button class="cat-card" title="{{ c.nombre }}"
                      (mouseenter)="onCategoriaHover(c)" (mouseleave)="onCategoriaHover()"
                      (click)="seleccionarCategoria(c)"
                      [class.cat-card--active]="categoriaActivaId === (c.idCategoria ?? null)"
                      [class.cat-card--hover]="categoriaHoverId === (c.idCategoria ?? null)">
                <span class="cat-card__label truncate">{{ c.nombre }}</span>
              </button>
            }
          }
        </div>

        <!-- Paginaci√≥n del grid -->
        <div class="mt-3 flex items-center justify-end gap-2">
          <button class="pager-btn pager-btn--ghost" (click)="anteriorPaginaCategorias()" [disabled]="paginaCategorias === 0">‚Üê</button>
          <button class="pager-btn pager-btn--ghost" (click)="siguientePaginaCategorias()" [disabled]="paginaCategorias + 1 >= totalPagCats">‚Üí</button>
        </div>
      </div>
    }

    <!-- Vista PRODUCTOS -->
    @if (modo === 'productos') {
      <div class="rounded-lg border border-gray-200 bg-gray-50 overflow-hidden flex-1">
        <table class="w-full text-sm">
          <thead class="bg-gray-100 text-[color:var(--color-ra-slate)]/90">
            <tr>
              <th class="px-3 py-2 text-left">Producto</th>
              <th class="px-3 py-2 text-center w-[120px]">Stock</th>
              <th class="px-3 py-2 text-right w-[140px]">Precio</th>
            </tr>
          </thead>
          <tbody>
            @if (cargandoProductos) {
              <tr><td colspan="3" class="px-3 py-8 text-center text-[color:var(--color-ra-slate)]">Cargando‚Ä¶</td></tr>
            } @else if (productosFiltrados.length === 0) {
              <tr><td colspan="3" class="px-3 py-8 text-center text-[color:var(--color-ra-slate)]">Sin resultados.</td></tr>
            } @else {
              @for (p of productosFiltrados; track p.idProducto) {
                <tr class="border-t border-gray-200 cursor-pointer"
                    [class.opacity-60]="toNumber(p.cantidad) <= 0"
                    [class.text-red-600]="toNumber(p.cantidad) <= 0"
                    [class.pointer-events-none]="toNumber(p.cantidad) <= 0"
                    [class.bg-red-50]="productoSeleccionado?.idProducto === p.idProducto"
                    (click)="seleccionarProducto(p)">
                  <td class="px-3 py-2 truncate" [title]="p.nombre">{{ p.nombre }}</td>
                  <td class="px-3 py-2 text-center">
                    {{ toNumber(p.cantidad) }}
                    @if (toNumber(p.cantidad) <= 0) { <span class="ml-1 text-xs font-semibold">(Sin stock)</span> }
                  </td>
                  <td class="px-3 py-2 text-right">
                    {{ toNumber(p.precioVenta) | currency:'USD':'symbol':'1.2-2' }}
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>

      <!-- Agregar al carrito -->
      <div class="flex items-center justify-end gap-3 mt-3">
        <label class="text-sm text-[color:var(--color-ra-slate)]">Cantidad:</label>
        <input type="number" min="1" class="w-24 input-filled" [(ngModel)]="cantidadParaAgregar">
        <button class="btn-red"
                [disabled]="!productoSeleccionado || cantidadParaAgregar < 1 || stockDisponible(productoSeleccionado!) <= 0"
                (click)="agregarAlCarrito()">
          Agregar
        </button>
      </div>
    }
  </section>
</div>

<!-- Modal Resumen de Venta -->
@if (mostrarModalResumen) {
  <div class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px]" (click)="cerrarModalResumen()"></div>

    <div class="relative z-10 w-full max-w-[560px] mx-4" (click)="$event.stopPropagation()">
      <app-resumen-venta
        [fecha]="fechaHoy"
        [items]="carrito"
        [total]="total"
        [guardando]="realizandoPago"
        tipoPagoInicial="EFECTIVO"
        (cancelar)="cerrarModalResumen()"
        (confirmar)="confirmarVentaDesdeModal($event)">
      </app-resumen-venta>
    </div>
  </div>
}
